---
title: 'Attacks on Civilians Before vs. After West Darfur Base Closures - Visual 7'
author: "Rob Boswell"
date: "7-27-2023"
output: html_document
class_options: landscape
---

```{r echo=FALSE}

library(stringr)

# Get the current page number from the file name
current_page <- as.numeric(str_extract(knitr::current_input(), "\\d+"))

# Set the total number of pages
total_pages <- 9

# Generate the URLs for the previous and next pages
previous_page <- ifelse(current_page > 1, paste0("visual_", current_page - 1, "-darfur_violence.html"), NA)
next_page <- ifelse(current_page < total_pages, paste0("visual_", current_page + 1, "-darfur_violence.html"), NA)

```

<ul class="pager">
  <li><a href="`r previous_page`">Previous Page</a></li>
  <li><a href="`r next_page`">Next Page</a></li>
</ul>

<br>

```{R Code for Visual 7 Maps, echo=FALSE, fig.height=18, fig.width=10, message=FALSE, warning=FALSE, include=FALSE}

library(raster)
library(rgdal)
library(tidyverse)
library(ggplot2)
library(ggthemes)
library(lubridate)
library(igraph)
library(ggraph) 
library(ggnetwork) 
library(GGally)
library(ggrepel) 
library(jsonlite) 
library(intergraph)
library(svgPanZoom) 
library(DT)
library(widgetframe)
library(tmap)
library(ggmap)
library(rgdal)
library(sp)
library(sf)


setwd("C:/Users/rsb84/Desktop/RB/COLUMBIA/QMSS/COURSES/Spring_2021/Data Visualization/End_project")


darfur_internal<-raster::shapefile("C:/Users/rsb84/Desktop/RB/COLUMBIA/QMSS/COURSES/Spring_2021/Data Visualization/End_project/darfur_internal.shp")


ACLED_data <- readxl::read_excel("ACLED-DARFUR-VAC-2008-2021 (After Course Ended-for 2023 Portfolio).xlsx", 
     col_types = c("date", "numeric", "text", 
         "text", "text", "text", "text", "text", 
         "text", "text", "text", "text", "text", 
         "numeric", "numeric", "text", 
         "text", "numeric", "numeric"))


acled_short=ACLED_data[c("event_date","year","sub_event_type","actor1","inter1","admin1","admin2","location","latitude","longitude","attacks","fatalities")]


acled_2016 = subset(acled_short, year == 2016)
acled_2017 = subset(acled_short, year == 2017)
acled_2018 = subset(acled_short, year == 2018)
acled_2019 = subset(acled_short, year == 2019)
acled_2020 = subset(acled_short, year == 2020)
acled_2021 = subset(acled_short, year == 2021)



write.csv(acled_2021,file='acled_2021.csv', row.names=FALSE)

CRS.new <- st_crs("EPSG:4087")

acled_2021 <- st_read("acled_2021.shp")
acled_2021 = readOGR(dsn = paste0(getwd()), layer="acled_2021")
acled_2021<-st_as_sf(acled_2021)
acled_2021 <- st_transform(acled_2021, CRS.new)

geo_pko <- readxl::read_excel("Geo-PKO-v-2-1-2023_portfolio-UNAMID-Only_Bases_Removed_Still_in_Dataset_AFTER_True_YEAR_withdrawn-All_Years.xlsx")

#Sources for the dates of UN base closures:
#https://oios.un.org/file/8866/download?token=F6tc9ZI5
#https://www.ecoi.net/en/file/local/2052225/S_2021_470_E.pdf
#https://peacekeeping.un.org/en/unamid-hands-back-former-iss-compound-to-agricultural-research-centre-el-fasher-north-darfur
#https://peacekeeping.un.org/en/unamid-expresses-concern-over-allegations-of-improper-team-site-handovers


#2016

geo_pko_for_maps_16 = filter(geo_pko, year == 2016)
geo_pko_df_16 = geo_pko_for_maps_16[c("year","location","latitude", "longitude")]
geo_pko_16_avg_troops_per_base = geo_pko_for_maps_16 %>% group_by(location) %>% summarise(avg.troops = mean(no.troops, na.rm=T))
geo_pko_df_16 = inner_join(geo_pko_16_avg_troops_per_base, geo_pko_df_16, by="location")
geo_pko_df_16 = distinct(geo_pko_df_16)
active_bases_2016 = geo_pko_df_16

#2017

geo_pko_for_maps_17 = filter(geo_pko, year == 2017)
geo_pko_df_17 = geo_pko_for_maps_17[c("year","location","latitude", "longitude")]
geo_pko_17_avg_troops_per_base = geo_pko_for_maps_17 %>% group_by(location) %>% summarise(avg.troops = mean(no.troops, na.rm=T))
geo_pko_df_17 = inner_join(geo_pko_17_avg_troops_per_base, geo_pko_df_17, by="location")
geo_pko_df_17 = distinct(geo_pko_df_17)
active_bases_2017 = geo_pko_df_17

#2018

geo_pko_for_maps_18 = filter(geo_pko, year == 2018)
geo_pko_df_18 = geo_pko_for_maps_18[c("year","location","latitude", "longitude")]
geo_pko_18_avg_troops_per_base = geo_pko_for_maps_18 %>% group_by(location) %>% summarise(avg.troops = mean(no.troops, na.rm=T))
geo_pko_df_18 = inner_join(geo_pko_18_avg_troops_per_base, geo_pko_df_18, by="location")
geo_pko_df_18 = distinct(geo_pko_df_18)

active_bases_2018 = geo_pko_df_18

#2019

geo_pko_for_maps_19 = filter(geo_pko, year == 2019)
geo_pko_df_19 = geo_pko_for_maps_19[c("year","location","latitude", "longitude")]
geo_pko_19_avg_troops_per_base = geo_pko_for_maps_19 %>% group_by(location) %>% summarise(avg.troops = mean(no.troops, na.rm=T))
geo_pko_df_19 = inner_join(geo_pko_19_avg_troops_per_base, geo_pko_df_19, by="location")
geo_pko_df_19 = distinct(geo_pko_df_19)

active_bases_2019 = geo_pko_df_19


#2020

geo_pko_for_maps_20 = filter(geo_pko, year == 2020)
geo_pko_df_20 = geo_pko_for_maps_20[c("year","location","latitude", "longitude")]
geo_pko_20_avg_troops_per_base = geo_pko_for_maps_20 %>% group_by(location) %>% summarise(avg.troops = mean(no.troops, na.rm=T))
geo_pko_df_20 = inner_join(geo_pko_20_avg_troops_per_base, geo_pko_df_20, by="location")
geo_pko_df_20 = distinct(geo_pko_df_20)

active_bases_2020 = geo_pko_df_20

darfur_internal<-raster::shapefile("C:/Users/rsb84/Desktop/RB/COLUMBIA/QMSS/COURSES/Spring_2021/Data Visualization/End_project/darfur_internal.shp")

#At this point, I make a "contains" spatial join using QGIS rather than R.

#I identify the second level administrative units in which each active UN base exists, and color the map by the average number of UN troops present during each year in a given administrative unit.

#active bases, 2016
coordinates(active_bases_2016)=~longitude+latitude
proj4string(active_bases_2016) <- CRS("+proj=longlat +datum=WGS84")
active_bases_2016<-spTransform(active_bases_2016, CRS("+proj=longlat"))
raster::shapefile(active_bases_2016, "active_bases_2016.shp", overwrite=T)

#active bases, 2017
coordinates(active_bases_2017)=~longitude+latitude
proj4string(active_bases_2017) = CRS("+proj=longlat +datum=WGS84")
active_bases_2017 <- spTransform(active_bases_2017, CRS("+proj=longlat"))
raster::shapefile(active_bases_2017, "active_bases_2017.shp", overwrite=T)

#active bases, 2018
coordinates(active_bases_2018)=~longitude+latitude
proj4string(active_bases_2018) <- CRS("+proj=longlat +datum=WGS84")
active_bases_2018<-spTransform(active_bases_2018, CRS("+proj=longlat"))
raster::shapefile(active_bases_2018, "active_bases_2018.shp", overwrite=T)

#active bases, 2019
coordinates(active_bases_2019)=~longitude+latitude
proj4string(active_bases_2019) <- CRS("+proj=longlat +datum=WGS84")
active_bases_2019<-spTransform(active_bases_2019, CRS("+proj=longlat"))
raster::shapefile(active_bases_2019, "active_bases_2019.shp", overwrite=T)

#active bases, 2020
coordinates(active_bases_2020)=~longitude+latitude
proj4string(active_bases_2020) <- CRS("+proj=longlat +datum=WGS84")
active_bases_2020<-spTransform(active_bases_2020, CRS("+proj=longlat"))
raster::shapefile(active_bases_2020, "active_bases_2020.shp", overwrite=T)


#For this set of maps, I focus on the administrative units specifically in West Darfur. I therefore used a polygon shapefile of Darfur, making it into a choropleth map based on the average number of troops stationed at bases in a given second level administrative region for a given year. I created 50 mile radius buffers emanating out from the coordinates of bases that were abandoned by the UN and calculated the number of attacks on civilians and the number of fatalities from such attacks within these buffers both in terms of the year before the bases were closed compared to the first year in which the bases were closed.

#We know that the UN bases withdrawn from West Darfur included the Forobaranga, Habila, and Tine bases in 2017, the El Sireaf, Masteri, Mournei, and Umm Barru bases in 2018, and the El Geneina base in 2019. 

#I therefore created three faceted maps: one comparing attacks on civilians within 50 miles from the Forobaranga, Habila, and Tine bases in 2016 vs. 2017, one comparing attacks on civilians within 50 miles of the El Sireaf, Masteri, Mournei, and Umm Barru bases in 2017 vs. 2018, and one comparing attacks on civilians within 50 miles of the El Geneina base in 2018 vs. 2019. However, no bases in West Darfur were removed in 2020.

#The first step will be to take the active_bases shapefiles I exported earlier, and to spatially join them to a Darfur polygon which contains second level administrative regions within it. I thus create spatially joined polygon shapefiles. I then upload these spatially joined files, and create choloropleth maps based again on the total average number of troops in a given second level administrative region for the years in which I am comparing discussed above:


#2016

my_box <- rgeos::bbox2SP(n = 16.12054, s = 8.64132, w = 24.61368, e = 27.58313, proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))

acled_2016 <- st_read("acled_2016.shp")
acled_2016 = rgdal::readOGR(dsn = paste0(getwd()), layer="acled_2016")
CRS.new <- st_crs("EPSG:4087")
acled_2016<-st_as_sf(acled_2016)
acled_2016 <- st_transform(acled_2016, CRS.new)


acled_2017 <- st_read("acled_2017.shp")
acled_2017 = readOGR(dsn = paste0(getwd()), layer="acled_2017")
CRS.new <- st_crs("EPSG:4087")
acled_2017<-st_as_sf(acled_2017)
acled_2017 <- st_transform(acled_2017, CRS.new)


acled_2020 <- st_read("acled_2020.shp")
acled_2020 = readOGR(dsn = paste0(getwd()), layer="acled_2020")
acled_2020<-st_as_sf(acled_2020)
acled_2020 <- st_transform(acled_2020, CRS.new)

active_bases_2016_joined<-st_read("active_bases_2016_joined.shp")
CRS.new <- st_crs("EPSG:4269")
active_bases_2016_joined = rgdal::readOGR(dsn = paste0(getwd()), layer="active_bases_2016_joined")
active_bases_2016_joined<-st_as_sf(active_bases_2016_joined)
active_bases_2016_joined.4269 <- st_transform(active_bases_2016_joined, CRS.new)


active_bases_2017_joined<-st_read("active_bases_2017_joined.shp")
CRS.new <- st_crs("EPSG:4269")
active_bases_2017_joined = readOGR(dsn = paste0(getwd()), layer="active_bases_2017_joined")
active_bases_2017_joined<-st_as_sf(active_bases_2017_joined)
active_bases_2017_joined.4269 <- st_transform(active_bases_2017_joined, CRS.new)


active_bases_2020_joined<-st_read("active_bases_2020_joined.shp")
CRS.new <- st_crs("EPSG:4269")
active_bases_2020_joined = readOGR(dsn = paste0(getwd()), layer="active_bases_2020_joined")
active_bases_2020_joined<-st_as_sf(active_bases_2020_joined)
active_bases_2020_joined.4269 <- st_transform(active_bases_2020_joined, CRS.new)


darfur_base_coordinates_2016<-st_read("active_bases_2016.shp")
darfur_base_coordinates_2016<-st_as_sf(darfur_base_coordinates_2016)
darfur_base_coordinates_2016 <- st_transform(darfur_base_coordinates_2016, CRS.new)


darfur_base_coordinates_2017<-st_read("active_bases_2017.shp")
darfur_base_coordinates_2017<-st_as_sf(darfur_base_coordinates_2017)
darfur_base_coordinates_2017 <- st_transform(darfur_base_coordinates_2017, CRS.new)

CRS.new <- st_crs("EPSG:4087")

darfur_base_coordinates_2020 <- st_read("active_bases_2020.shp")
darfur_base_coordinates_2020 <- st_as_sf(darfur_base_coordinates_2020)
darfur_base_coordinates_2020 <- st_transform(darfur_base_coordinates_2020, CRS.new)


tmap_mode("plot")


my_box <- rgeos::bbox2SP(n = 16.12054, s = 8.64132, w = 21.61368, e = 29.58313, proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))

#2016 vs. 2017
#2016

CRS.new <- st_crs("EPSG:4269")
active_bases_2016_joined.4269 <- st_transform(active_bases_2016_joined, CRS.new)
acled_2016 = readOGR(dsn = paste0(getwd()), layer="acled_2016")
acled_2016<-st_as_sf(acled_2016)


CRS.new <- st_crs("EPSG:4087")

acled_2016 <- st_transform(acled_2016, CRS.new)

CRS.new <- st_crs("EPSG:4087")
closed_bases_west_2017 <-raster::shapefile("C:/Users/rsb84/Desktop/RB/COLUMBIA/QMSS/COURSES/Spring_2021/Data Visualization/End_project/closed_bases_west_2017-portfolio_2023.shp")
closed_bases_west_2017=st_as_sf(closed_bases_west_2017)
closed_bases_west_2017=st_transform(closed_bases_west_2017, CRS.new)

closed_bases_west_2017_buffers <- st_buffer(closed_bases_west_2017, 80467.2)

unionBuffers <- st_union(closed_bases_west_2017_buffers)

acled_2016$fatalities = as.numeric(acled_2016$fatalities)
tmap_mode("plot")

# Set the breaks for "Average Number of Troops"
troops_breaks <- c(0, 200, 400, 600, 800, 1000)

# Set the breaks and labels for "Fatalities"
fatalities_breaks <- c(0, 10, 20, 30, 40, 50)
fatalities_labels <- c("0 to 10", "10 to 20", "20 to 30", "30 to 40", "40 to 50")


# Layout with Title
layout1 <- tm_layout(
          title = "Attacks on Civilians, Before vs. After the 2017\n Forobaranga, Habila, and Tine Base Closures",
          title.position = c("left","top"),
          title.size=20, title.color="steelblue", fontface = 7,
          legend.title.size = 1,
          legend.title.color = "steelblue",
          legend.text.size = 0.8,
          legend.text.color = "steelblue",
          #legend.position = c("right","center"),
          legend.position = c(0.74,0.25),#c(horizontal, vertical)
          legend.bg.color = "white",
          legend.bg.alpha = 1,
          bg.color="white",
          frame=FALSE)

layout2 <- tm_layout(
          title = "Attacks on Civilians, Before vs. After the 2018\n El Sireaf, Masteri, Mournei and Umm Barru\n Base Closures",
          title.position = c("left","top"),
          title.size=20, title.color="steelblue", fontface = 7,
          legend.title.size = 1,
          legend.title.color = "steelblue",
          legend.text.size = 0.8,
          legend.text.color = "steelblue",
          #legend.position = c("right","center"),
          legend.position = c(0.745,0.25),#c(horizontal, vertical)
          legend.bg.color = "white",
          legend.bg.alpha = 1,
          bg.color="white",
          frame=FALSE)

layout3 <- tm_layout(
          title = "Attacks on Civilians, Before vs. After the 2019\n El Geneina Base Closure",
          title.position = c("left","top"),
          title.size=20, title.color="steelblue", fontface = 7,
          legend.title.size = 1,
          legend.title.color = "steelblue",
          legend.text.size = 0.8,
          legend.text.color = "steelblue",
          #legend.position = c("right","center"),
          legend.position = c(0.753,0.25),#c(horizontal, vertical)
          legend.bg.color = "white",
          legend.bg.alpha = 1,
          bg.color="white",
          frame=FALSE)

layout4 <- tm_layout(
          title = "Attacks on Civilians, the Year of vs. the Year\n After the 2020 El Geneina Base Closure",
          title.position = c("left","top"),
          title.size=20, title.color="steelblue", fontface = 7,
          legend.title.size = 1,
          legend.title.color = "steelblue",
          legend.text.size = 0.8,
          legend.text.color = "steelblue",
          #legend.position = c("right","center"),
          legend.position = c(0.78,0.25),#c(horizontal, vertical)
          legend.bg.color = "white",
          legend.bg.alpha = 1,
          bg.color="white",
          frame=FALSE)

# Define the layout object without title
layout_no_title <- tm_layout(
          title = "",  
          title.size=20, title.color="steelblue", fontface = 7,
          legend.title.size = 1,
          legend.title.color = "steelblue",
          legend.text.size = 0.8,
          legend.text.color = "steelblue",
          #legend.position = c("right","center"),
          legend.position = c(0.79,0.25),#c(horizontal, vertical)
          legend.bg.color = "white",
          legend.bg.alpha = 1,
          bg.color="white",
          frame=FALSE)

t_2016.1 = tm_shape(active_bases_2016_joined.4269, bbox = my_box) + tm_fill("avg_troops", title="Average Number\nof UN Troops", palette="Greens") + 
layout1 +
tm_borders() +
tm_add_legend(title="") +
tm_shape(closed_bases_west_2017) + 
tm_dots(size=0.5, col="steelblue") +
tm_shape(unionBuffers) + 
tm_borders(col = "blue") + 
tm_shape(acled_2016)+
tm_bubbles(size="fatalities", col="red", alpha=0.3, jitter=0.05, title.size="Fatalities", breaks=c(0,10,20,30,40,50), sizes.legend=c(20,40,60,80,100), sizes.legend.labels=c("10","20","30","40","50"))+
tm_credits(text="2016", position=c("center", "bottom"), size=1.5)

#library("GISTools")

#2017

CRS.new <- st_crs("EPSG:4269")
active_bases_2017_joined = readOGR(dsn = paste0(getwd()), layer="active_bases_2017_joined")
active_bases_2017_joined <- st_as_sf(active_bases_2017_joined)
active_bases_2017_joined.4269 <- st_transform(active_bases_2017_joined, CRS.new)


CRS.new <- st_crs("EPSG:4087")
acled_2017 = readOGR(dsn = paste0(getwd()), layer="acled_2017")
acled_2017<-st_as_sf(acled_2017)
acled_2017 <- st_transform(acled_2017, CRS.new)


acled_2018 = readOGR(dsn = paste0(getwd()), layer="acled_2018")
acled_2018<-st_as_sf(acled_2018)
acled_2018 <- st_transform(acled_2018, CRS.new)


acled_2019 = readOGR(dsn = paste0(getwd()), layer="acled_2019")
acled_2019<-st_as_sf(acled_2019)
acled_2019 <- st_transform(acled_2019, CRS.new)


closed_bases_west_2017_buffers <- st_buffer(closed_bases_west_2017, 80467.2)
unionBuffers <- st_union(closed_bases_west_2017_buffers)


#Calculating fatalities (sum) and attacks (length) in 2016 - Buffer 2017
fatality_sum_2016.buffer_2017 = sf::st_filter(acled_2016, closed_bases_west_2017_buffers, .pred = st_within)
fatality_sum_2016.buffer_2017$fatalities = as.numeric(fatality_sum_2016.buffer_2017$fatalities)
length(fatality_sum_2016.buffer_2017$fatalities)
sum(fatality_sum_2016.buffer_2017$fatalities)

#Calculating fatalities (sum) and attacks (length) in 2017 - buffer 2017
fatality_sum_2017.buffer_2017 = sf::st_filter(acled_2017, closed_bases_west_2017_buffers, .pred = st_within)
length(fatality_sum_2017.buffer_2017$fatalts)
sum(fatality_sum_2017.buffer_2017$fatalts)

#Calculating fatalities (sum) and attacks (length) in 2018 - buffer 2017
fatality_sum_2018.buffer_2017 = sf::st_filter(acled_2018, closed_bases_west_2017_buffers, .pred = st_within)
length(fatality_sum_2018.buffer_2017$fatalts)
sum(fatality_sum_2018.buffer_2017$fatalts)

#Calculating fatalities (sum) and attacks (length) in 2019 - buffer 2017
fatality_sum_2019.buffer_2017 = sf::st_filter(acled_2019, closed_bases_west_2017_buffers, .pred = st_within)
length(fatality_sum_2019.buffer_2017$fatalts)
sum(fatality_sum_2019.buffer_2017$fatalts)

#Calculating fatalities (sum) and attacks (length) in 2020 - buffer 2017
fatality_sum_2020.buffer_2017 = sf::st_filter(acled_2020, closed_bases_west_2017_buffers, .pred = st_within)
length(fatality_sum_2020.buffer_2017$fatalts)
sum(fatality_sum_2020.buffer_2017$fatalts)

#Calculating fatalities (sum) and attacks (length) in 2021 - buffer 2017
fatality_sum_2021.buffer_2017 = sf::st_filter(acled_2021, closed_bases_west_2017_buffers, .pred = st_within)
fatality_sum_2021.buffer_2017$fatalities = as.numeric(fatality_sum_2021.buffer_2017$fatalities)
length(fatality_sum_2021.buffer_2017$fatalities)
sum(fatality_sum_2021.buffer_2017$fatalities)

acled_2017$fatalts = as.numeric(acled_2017$fatalts)

tmap_mode("plot")

t_2017.1=tm_shape(active_bases_2017_joined.4269, bbox =my_box) + tm_fill("avg_troops", title="Average Number\nof UN Troops", palette="Greens") + 
layout_no_title +
tm_borders() +
tm_add_legend(title="") +
tm_shape(closed_bases_west_2017) + 
tm_dots(size=0.5, col="steelblue") +
tm_shape(unionBuffers) + 
tm_borders(col = "blue") + 
tm_shape(acled_2017)+
tm_bubbles(size="fatalts", col="red", alpha=0.3, jitter=0.05, title.size="Fatalities", breaks=c(0,10,20,30,40,50), sizes.legend=c(5,10,15,20,25), sizes.legend.labels=c("10","20","30","40","50"))+
tm_credits(text="2017", position=c("center", "bottom"), size=1.5)+
tm_legend(show = FALSE)

#2017 vs. 2018
#2017

CRS.new <- st_crs("EPSG:4269")
active_bases_2017_joined.4269 <- st_transform(active_bases_2017_joined, CRS.new)
acled_2017 = readOGR(dsn = paste0(getwd()), layer="acled_2017")
#closed_bases_west_2018 = readOGR(dsn = paste0(getwd()), layer="closed_bases_west_2018")

CRS.new <- st_crs("EPSG:4087")
closed_bases_west_2018 <-raster::shapefile("C:/Users/rsb84/Desktop/RB/COLUMBIA/QMSS/COURSES/Spring_2021/Data Visualization/End_project/closed_bases_west_2018-portfolio_2023.shp")
closed_bases_west_2018=st_as_sf(closed_bases_west_2018)
closed_bases_west_2018=st_transform(closed_bases_west_2018, CRS.new)


CRS.new <- st_crs("EPSG:4087")
acled_2017<-st_as_sf(acled_2017)
#closed_bases_west_2018 <- st_as_sf(closed_bases_west_2018)


acled_2017 <- st_transform(acled_2017, CRS.new)
acled_2017$fatalts = as.numeric(acled_2017$fatalts)

closed_bases_west_2018 <- st_transform(closed_bases_west_2018, CRS.new)
closed_bases_west_2018_buffers <- st_buffer(closed_bases_west_2018, 80467.2)
unionBuffers <- st_union(closed_bases_west_2018_buffers)

tmap_mode("plot")

t_2017.2 = tm_shape(active_bases_2017_joined.4269, bbox = my_box) + tm_fill("avg_troops", title="Average Number\nof UN Troops", palette="Greens") + 
layout2 +
tm_borders() +
tm_add_legend(title="") +
tm_shape(closed_bases_west_2018) + 
tm_dots(size=0.5, col="steelblue") +
tm_shape(unionBuffers) + 
tm_borders(col = "blue") + 
tm_shape(acled_2017)+
tm_bubbles(size="fatalts", col="red", alpha=0.3, jitter=0.05, title.size="Fatalities", breaks=c(0,10,20,30,40,50), sizes.legend=c(5,10,15,20,25), sizes.legend.labels=c("10","20","30","40","50"))+
tm_credits(text="2017", position=c("center", "bottom"), size=1.5)


#2018

CRS.new <- st_crs("EPSG:4269")
active_bases_2018_joined = readOGR(dsn = paste0(getwd()), layer="active_bases_2018_joined")
active_bases_2018_joined <- st_as_sf(active_bases_2018_joined)
active_bases_2018_joined.4269 <- st_transform(active_bases_2018_joined, CRS.new)


CRS.new <- st_crs("EPSG:4087")
closed_bases_west_2018 <-raster::shapefile("C:/Users/rsb84/Desktop/RB/COLUMBIA/QMSS/COURSES/Spring_2021/Data Visualization/End_project/closed_bases_west_2018-portfolio_2023.shp")
closed_bases_west_2018=st_as_sf(closed_bases_west_2018)
closed_bases_west_2018=st_transform(closed_bases_west_2018, CRS.new)


acled_2018 = readOGR(dsn = paste0(getwd()), layer="acled_2018")
acled_2018<-st_as_sf(acled_2018)
acled_2018 <- st_transform(acled_2018, CRS.new)


acled_2019 = readOGR(dsn = paste0(getwd()), layer="acled_2019")
acled_2019<-st_as_sf(acled_2019)
acled_2019 <- st_transform(acled_2019, CRS.new)


acled_2020 = readOGR(dsn = paste0(getwd()), layer="acled_2020")
acled_2020<-st_as_sf(acled_2020)
acled_2020 <- st_transform(acled_2020, CRS.new)

acled_2021 = readOGR(dsn = paste0(getwd()), layer="acled_2021")
acled_2021<-st_as_sf(acled_2021)
acled_2021 <- st_transform(acled_2021, CRS.new)


closed_bases_west_2018_buffers <- st_buffer(closed_bases_west_2018, 80467.2)
unionBuffers <- st_union(closed_bases_west_2018_buffers)

#CALCULATNG FATALITIES PER YEAR INSIDE THE 50 MILE BUFFER AROUND BASES CLOSED IN 2018
#length() calculates the number of civilian attacks
#sum() calculates the number of fatalities from these attacks

#Calculating fatalities (sum) and attacks (length) in 2016 - Buffer in 2018
fatality_sum_2016.buffer_2018 = sf::st_filter(acled_2016, closed_bases_west_2018_buffers, .pred = st_within)
length(fatality_sum_2016.buffer_2018$fatalities)
sum(fatality_sum_2016.buffer_2018$fatalities)


#Calculating fatalities (sum) and attacks (length)  in 2017 - Buffer in 2018
fatality_sum_2017.buffer_2018 = sf::st_filter(acled_2017, closed_bases_west_2018_buffers, .pred = st_within)
length(fatality_sum_2017.buffer_2018$fatalts)
sum(fatality_sum_2017.buffer_2018$fatalts)

#Calculating fatalities (sum) and attacks (length) in 2018 - Buffer in 2018
fatality_sum_2018.buffer_2018 = sf::st_filter(acled_2018, closed_bases_west_2018_buffers, .pred = st_within)
length(fatality_sum_2018.buffer_2018$fatalts)
sum(fatality_sum_2018.buffer_2018$fatalts)

#Calculating fatalities (sum) and attacks (length)  in 2019 - Buffer in 2018
fatality_sum_2019.buffer_2018 = sf::st_filter(acled_2019, closed_bases_west_2018_buffers, .pred = st_within)
length(fatality_sum_2019.buffer_2018$fatalts)
sum(fatality_sum_2019.buffer_2018$fatalts)

#Calculating fatalities (sum) and attacks (length)  in 2020 - Buffer in 2018
fatality_sum_2020.buffer_2018 = sf::st_filter(acled_2020, closed_bases_west_2018_buffers, .pred = st_within)
length(fatality_sum_2020.buffer_2018$fatalts)
sum(fatality_sum_2020.buffer_2018$fatalts)

#Calculating fatalities (sum) and attacks (length) in 2021 - Buffer in 2018
fatality_sum_2021.buffer_2018 = sf::st_filter(acled_2021, closed_bases_west_2018_buffers, .pred = st_within)
fatality_sum_2021.buffer_2018$fatalities=as.numeric(fatality_sum_2021.buffer_2018$fatalities)
length(fatality_sum_2021.buffer_2018$fatalities)
sum(fatality_sum_2021.buffer_2018$fatalities)

acled_2018$fatalts = as.numeric(acled_2018$fatalts)

tmap_mode("plot")

t_2018.2=tm_shape(active_bases_2018_joined.4269, bbox =my_box) + tm_fill("avg_troops", title="Average Number\nof UN Troops", palette="Greens") + 
layout_no_title +
tm_borders() +
tm_add_legend(title="") +
tm_shape(closed_bases_west_2018) + 
tm_dots(size=0.5, col="steelblue") +
tm_shape(unionBuffers) + 
tm_borders(col = "blue") + 
tm_shape(acled_2018)+
tm_bubbles(size="fatalts", col="red", alpha=0.3, jitter=0.05, title.size="Fatalities", breaks=c(0,10,20,30,40,50), sizes.legend=c(5,10,15,20,25), sizes.legend.labels=c("10","20","30","40","50"))+
tm_credits(text="2018", position=c("center", "bottom"), size=1.5)+ 
tm_legend(show = FALSE)


#2018 vs. 2019

#2018

my_box <- rgeos::bbox2SP(n = 16.12054, s = 8.64132, w = 21.61368, e = 29.58313, proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))

CRS.new <- st_crs("EPSG:4269")

active_bases_2018_joined = readOGR(dsn = paste0(getwd()), layer="active_bases_2018_joined")

active_bases_2018_joined <- st_as_sf(active_bases_2018_joined)

active_bases_2018_joined.4269 <- st_transform(active_bases_2018_joined, CRS.new)

CRS.new <- st_crs("EPSG:4087")

closed_bases_west_2019 <-raster::shapefile("C:/Users/rsb84/Desktop/RB/COLUMBIA/QMSS/COURSES/Spring_2021/Data Visualization/End_project/closed_bases_west_2019-portfolio_2023.shp")
closed_bases_west_2019=st_as_sf(closed_bases_west_2019)
closed_bases_west_2019=st_transform(closed_bases_west_2019, CRS.new)


acled_2018 = readOGR(dsn = paste0(getwd()), layer="acled_2018")
acled_2018<-st_as_sf(acled_2018)
acled_2018 <- st_transform(acled_2018, CRS.new)
acled_2018$fatalts = as.numeric(acled_2018$fatalts)

closed_bases_west_2019_buffers <- st_buffer(closed_bases_west_2019, 80467.2)
unionBuffers <- st_union(closed_bases_west_2019_buffers)

tmap_mode("plot")

t_2018.3=tm_shape(active_bases_2018_joined.4269, bbox =my_box) + tm_fill("avg_troops", title="Average Number\nof UN Troops", palette="Greens") + 
layout3 +
tm_borders() +
tm_shape(closed_bases_west_2019) + 
tm_dots(size=0.5, col="steelblue") +
tm_shape(acled_2018)+
tm_bubbles(size="fatalts", col="red", alpha=0.3, jitter=0.05, title.size="Fatalities", breaks=c(0,10,20,30,40,50), sizes.legend=c(10,20,30,40,50), sizes.legend.labels=c("10","20","30","40","50"))+
tm_shape(unionBuffers) + 
tm_borders(col = "blue") +  
tm_credits(text="2018", position=c("center", "bottom"), size=1.5)


#2019

CRS.new <- st_crs("EPSG:4269")
active_bases_2019_joined = readOGR(dsn = paste0(getwd()), layer="active_bases_2019_joined")
active_bases_2019_joined <- st_as_sf(active_bases_2019_joined)
active_bases_2019_joined.4269 <- st_transform(active_bases_2019_joined, CRS.new)

CRS.new <- st_crs("EPSG:4087")


acled_2019 = readOGR(dsn = paste0(getwd()), layer="acled_2019")
acled_2019 <-st_as_sf(acled_2019)
acled_2019 <- st_transform(acled_2019, CRS.new)


closed_bases_west_2019_buffers <- st_buffer(closed_bases_west_2019, 80467.2)
unionBuffers <- st_union(closed_bases_west_2019_buffers)


#Calculating fatalities (sum) and attacks (length) in 2016 - Buffer 2019
fatality_sum_2016.buffer_2019 = sf::st_filter(acled_2016, closed_bases_west_2019_buffers, .pred = st_within)
length(fatality_sum_2016.buffer_2019$fatalities)
sum(fatality_sum_2016.buffer_2019$fatalities)

#Calculating fatalities (sum) and attacks (length) in 2017 - Buffer 2019
fatality_sum_2017.buffer_2019 = sf::st_filter(acled_2017, closed_bases_west_2019_buffers, .pred = st_within)
length(fatality_sum_2017.buffer_2019$fatalts)
sum(fatality_sum_2017.buffer_2019$fatalts)


#Calculating fatalities (sum) and attacks (length) in 2018 - Buffer 2019
fatality_sum_2018.buffer_2019 = sf::st_filter(acled_2018, closed_bases_west_2019_buffers, .pred = st_within)
length(fatality_sum_2018.buffer_2019$fatalts)
sum(fatality_sum_2018.buffer_2019$fatalts)


#Calculating fatalities (sum) and attacks (length) in 2019 - Buffer 2019
fatality_sum_2019.buffer_2019 = sf::st_filter(acled_2019, closed_bases_west_2019_buffers, .pred = st_within)
length(fatality_sum_2019.buffer_2019$fatalts)
sum(fatality_sum_2019.buffer_2019$fatalts)


#Calculating fatalities (sum) and attacks (length) in 2020 - Buffer 2019
fatality_sum_2020.buffer_2019 = sf::st_filter(acled_2020, closed_bases_west_2019_buffers, .pred = st_within)
length(fatality_sum_2020.buffer_2019$fatalts)
sum(fatality_sum_2020.buffer_2019$fatalts)


#Calculating fatalities (sum) and attacks (length) in 2021 - Buffer 2019
fatality_sum_2021.buffer_2019 = sf::st_filter(acled_2021, closed_bases_west_2019_buffers, .pred = st_within)
fatality_sum_2021.buffer_2019$fatalities=as.numeric(fatality_sum_2021.buffer_2019$fatalities)
length(fatality_sum_2021.buffer_2019$fatalities)
sum(fatality_sum_2021.buffer_2019$fatalities)

acled_2019$fatalts = as.numeric(acled_2019$fatalts)

tmap_mode("plot")

t_2019.3=tm_shape(active_bases_2019_joined.4269, bbox =my_box) + tm_fill("avg_troops", title="Average Number\nof UN Troops", palette="Greens") + 
layout_no_title +
tm_borders() +
tm_add_legend(title="") +
tm_shape(closed_bases_west_2019) + 
tm_dots(size=0.5, col="steelblue") +
tm_shape(unionBuffers) + 
tm_borders(col = "blue") + 
tm_shape(acled_2019)+
tm_bubbles(size="fatalts", col="red", alpha=0.3, jitter=0.05, title.size="Fatalities", breaks=c(0,10,20,30,40,50), sizes.legend=c(5,10,15,20,25), sizes.legend.labels=c("10","20","30","40","50"))+
tm_credits(text="2019", position=c("center", "bottom"), size=1.5)+ 
tm_legend(show = FALSE)

#2019 vs. 2020

#2019

my_box <- rgeos::bbox2SP(n = 16.12054, s = 8.64132, w = 21.61368, e = 29.58313, proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))


CRS.new <- st_crs("EPSG:4269")
active_bases_2019_joined = readOGR(dsn = paste0(getwd()), layer="active_bases_2019_joined")
active_bases_2019_joined <- st_as_sf(active_bases_2019_joined)
active_bases_2019_joined.4269 <- st_transform(active_bases_2019_joined, CRS.new)

CRS.new <- st_crs("EPSG:4087")


acled_2019 = readOGR(dsn = paste0(getwd()), layer="acled_2019")
acled_2019 <- st_as_sf(acled_2019)
acled_2019 <- st_transform(acled_2019, CRS.new)

acled_2019$fatalts = as.numeric(acled_2019$fatalts)

tmap_mode("plot")

t_2019.4=tm_shape(active_bases_2019_joined.4269, bbox =my_box) + tm_fill("avg_troops", title="Average Number\nof UN Troops", palette="Greens") + 
layout4 +
tm_borders() +
tm_add_legend(title="") +
tm_shape(closed_bases_west_2019) + 
tm_dots(size=0.5, col="steelblue") +
tm_shape(unionBuffers) + 
tm_borders(col = "blue") + 
tm_shape(acled_2019)+
tm_bubbles(size="fatalts", col="red", alpha=0.3, jitter=0.05, title.size="Fatalities", breaks=c(0,10,20,30,40,50), sizes.legend=c(10,20,30,40,50), sizes.legend.labels=c("10","20","30","40","50"))+
tm_credits(text="2019", position=c("center", "bottom"), size=1.5)


#2020

CRS.new <- st_crs("EPSG:4269")
active_bases_2020_joined = readOGR(dsn = paste0(getwd()), layer="active_bases_2020_joined")
active_bases_2020_joined <- st_as_sf(active_bases_2020_joined)
active_bases_2020_joined.4269 <- st_transform(active_bases_2020_joined, CRS.new)

CRS.new <- st_crs("EPSG:4087")

acled_2020 = readOGR(dsn = paste0(getwd()), layer="acled_2020")
acled_2020 <-st_as_sf(acled_2020)
acled_2020 <- st_transform(acled_2020, CRS.new)


acled_2020$fatalts = as.numeric(acled_2020$fatalts)



tmap_mode("plot")

t_2020.4=tm_shape(active_bases_2020_joined.4269, bbox =my_box) + tm_fill("avg_troops", title="Average Number\nof UN Troops", palette="Greens") + 
layout_no_title +
tm_borders() +
tm_add_legend(title="") +
tm_shape(closed_bases_west_2019) + 
tm_dots(size=0.5, col="steelblue") +
tm_shape(unionBuffers) + 
tm_borders(col = "blue") + 
tm_shape(acled_2020)+
tm_bubbles(size="fatalts", col="red", alpha=0.3, jitter=0.05, title.size="Fatalities", breaks=c(0,10,20,30,40,50), sizes.legend=c(5,10,15,20,25), sizes.legend.labels=c("10","20","30","40","50"))+
tm_credits(text="2020", position=c("center", "bottom"), size=1.5)+ 
tm_legend(show = FALSE)

```


```{R Combined 8 Maps, echo=FALSE, fig.height=18, fig.width=10, message=FALSE, warning=FALSE}


tmap_arrange(t_2016.1, t_2017.1, t_2017.2, t_2018.2, t_2018.3, t_2019.3, nrow = 3, ncol = 2, asp=1, outer.margins = 0)

```


#### The first visual on this page compares 50 mile radius buffers around the West Darfur UN bases in Forobaranga, Habila, and Tine that were closed in 2017 with the same areas around these bases in 2016 before they closed. It visually appears that there was a slight increase in attacks on civilians in 2017. Yet, I calculate that while there were 32 attacks and 27 fatalities in 2016 within 50 miles of these bases, there were actually just 29 attacks and 11 fatalities in 2017. Thus, the number of attacks remained roughly the same, while fatalities dropped by more than half after these 3 bases closed.

<br>

#### Next, I visually compare violence inside 50 mile radius buffers around the 4 UN bases in West Darfur that closed in 2018 with levels of violence in these same areas in 2017 before they had closed. Visually, there definitely appears to be a reduction in the number of attacks on civilians and possibly the number of fatalities too (although with fatalities it is more difficult to tell because of the existence of two large bubbles in the southern parts of the buffers). Yet, I find through my calculations that whereas 62 attacks and 30 civilian killings occurred within 50 miles of these 4 compounds in 2017, the number of attacks decreased in 2018 (39) while the number of civilian killings actually increased to 35.

<br>

#### In the third set of map pairs (Darfur in 2018 vs. 2019), when comparing the 50 mile radius buffer around the UN base in Habila that was withdrawn in 2019, it visually appears there was an increase in the number of attacks from 2018 to 2019. However, it is harder to tell visually whether fatality totals are higher in the 2019 map because there are 2 attacks that occurred within the buffer in the 2018 map that garnered large civilian fatalities (shown as the two large bubbles), whereas there is one very large bubble (i.e., an attack with an especially high fatality total) in the center of the 2019 map. Further, within this bubble are additional smaller bubbles, representing separate attacks with smaller numbers of fatalities. However, my calculations show that while there were 13 attacks and 24 civilian killings in 2018, attacks and fatalities actually increased to 20 and 46, respectively, in 2019.

<br>

#### Additionally, although not shown in these maps, when I calculate the number of attacks and fatalities that occurred during the year 2021 within 50 miles of the closed UN compounds in these 3 map pairs, I find 15 attacks and 46 fatalities occurred in 2021 within the area of the 2017 buffers, that 66 attacks and 141 fatalities occurred in 2021 occurred within the area of the 2018 buffers, and that 43 attacks and 127 fatalities in 2021 occurred within the area of the 2019 buffer. It is difficult to infer the exact cause of this spike in fatalities in 2021 that occurred within the area of the 50 mile radius buffers around closed UN bases in all 3 sets of maps, or to determine that this spike would not have occurred had the West Darfur bases and the UN troops stationed there not been withdrawn. Yet, it is at least possible that the effect of multiple rounds of UN base withdrawals over multiple years led to a sudden burst of violence in 2021 due to a power vacuume emerging. However, it is also possible that other factors were at least partly responsible for these heightened levels of violence in 2021.

```{r echo=FALSE}

library(stringr)

# Get the current page number from the file name
current_page <- as.numeric(str_extract(knitr::current_input(), "\\d+"))

# Set the total number of pages
total_pages <- 9

# Generate the URLs for the previous and next pages
previous_page <- ifelse(current_page > 1, paste0("visual_", current_page - 1, "-darfur_violence.html"), NA)
next_page <- ifelse(current_page < total_pages, paste0("visual_", current_page + 1, "-darfur_violence.html"), NA)

```

<ul class="pager">
  <li><a href="`r previous_page`">Previous Page</a></li>
  <li><a href="`r next_page`">Next Page</a></li>
</ul>